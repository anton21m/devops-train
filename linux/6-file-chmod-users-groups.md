### Структура файловой системы. Уровни доступа. Права и пользователи-владельцы
В linux  системах все файлы (набор байтов). Бывают обычные и специальные файлы а также директории.
 К обычнам относятся:
    - текстовые
    - бинарные
    - файлы изображений
    - архивы и т.п.
К специальным относятся:
    - блочные для обозначения устройств
    - символьные
    - ссылочные для представления символьных ссылок
    - файлы сокетов для связи между разными процессами и пр.

file [имя файла] узнать тип файла
file .bash_history узнать тип файла
bash_history: Bourne-Again shell script, Unicode text, UTF-8 text executable, with very long lines (365)

Все папки корневой файловой структуры имеют значения:
    - bin содержит исполняемые бинарные файлы, доступны для запуска любому пользователю, является символьной ссылкой на /usr/bin
    - boot сердце системы, содержит загрузчик файловой системы и ядра
    - dev содержит файлы устройств подключенных к серверу, включая терминал, спец. устройста типа null, random, zero, диск
    - etc содержит все конфигурационные файлы служб, скрипты их запуска и отключения
    - home для домашних каталогов пользователей
    - lib и lib64 библиотеки для работы системных служб, данные для загрузки ОС. Является символьной ссылкой на /usr/lib(64)
    - media монтирует внешние устройства
    - mnt используется для временного монтирования внешних устройств
    - opt устанавливается пользовательское ПО
    - proc хранятся процессы, каждая папка PID процесса
    - root домашняя папка для корневого пользователя root
    - run данные хранимые в ОЗУ, активные сокеты
    - sbin исполняемые бинарные файлы, только для доступа с правами администратора. Является символьной ссылкой на /usr/sbin
    - srv общедоступные данные для сервисных служб
    - sys содержит виртуальную файловую систему, в этот раздел эксортируются данные ядра ОС и его модулей.
    - tmp для хранения временных файлов
    - usr хранятся исполняемы файлы, библиотеки, файлы документации man, компоненты ядра, данные о программа установленных пользователем
    - var содержит часто изменяемые данные, кеши, var/cache, логи - var/log, очереди - var/spool

#### управление пользователями в linux системах

В linux системах 3 типа пользователей:
    - администраторы с полным доступом к системе (root) с UID 0
    - обычные пользователи (ограниченный доступ к системе) c UID > 100
    - системные пользователи для работы служб и ограничения им доступа с UID от 1 до 100

Для упрощения настройки прав пользователям их объединяют в группы. Каждая группа имеет свой набор прав и ограничений. 
Если не указать группу при создании пользователя у него будет своя индивидуальная группа с именем пользователя.

cat /etc/passwd информацию о пользователях и группах

Формат файла /etc/passwd

anton:x:1000:1000:anton,,,:/home/anton:/bin/bash
[имя]:[x- означает пароль зашифрован и хранится в /etc/shadow]:[UID пользователя]:[GID идентификатор группы],,,:[домагняя папка пользователя]:[командная оболочка пользователя]

Чтобы просмотреть в удобочитаемом виде:
pinky -l [имя пользователя]

pinky покажет всех авторизуемых пользователей

w покажет всех авторизуемых пользователей и нагрузку на каждого пользователя, а также время работы сервера

id [имя пользователя] показать UID и все GID пользователя

### Права и пользователи-владельцы

Права пользователя расшифровываются как:

drwxrwxr-x  3 anton root 4096 Aug 25 13:59 kafka
    - тип файла (d директория)
    rwx доступ к чтению, записи, и исполнению(переход в директорию) для владельца
    rwx доступ к чтению, записи, и исполнению(переход в директорию) для группы владельца
    r-x доступ к чтению и исполнению(переход в директорию) для остальных
    anton папка принадлежит пользователю anton
    anton  папка принадлежит группе root

Доступен также 8 меричный формат

![Alt text](image-1.png)

chown [name or UID]:[name or GID] [файлы и папки]
chown -R new-user:new-group /home/users/new-user изменить владельца и группу рекурсивно

chgrp [группа] [файлы и папки] изменить группу для файлов и папок
chgrp root /var/tmp/run.sh изменяет группу на root

chmod [настройки прав] [файлы и папки]
    u - владелец
    g - группа владельца
    a - все остальные
chmod 777 example.txt дать полные права на файл
chmod a-x example.txt забрать права на исполнение у всех пользователей
chmod u+x example.txt дать права на исполнение владельцу

#### Создание нового пользователя

useradd [как создать] [как назвать] создать нового пользователя

Эта команда имеет ряд настроек по умолчанию, которые задаются с помощью файлов /etc/default/useradd и /etc/login.defs Увидеть основные можно с помощью команды:

useradd -D просмотреть настройки по  умолчанию в компактном виде


GROUP
GID группы, в которую пользователь будет добавлен после создания

HOME
базовый каталог, в котором будет размещена директория пользователя

INACTIVE
указывает время до блокировки пользователя, когда его пароль станет недействителен. Значение «-1» отключает опцию

EXPIRE
дата, до которой действителен аккаунт. По умолчанию не установлена — то есть без ограничений

SHELL
используется для настройки доступа к командной оболочке

SKEL
содержит путь к директории, в которой хранятся файлы по умолчанию. После создания пользователя они будут автоматически скопированы в его домашнюю папку

CREATE_MAIL_SPOOL
определяет, нужно ли создать папку для писем этого пользователя в /var/spool/mail/

Все эти настройки применяются, если использовать самый простой вариант команды создания пользователя без параметров:

Но обычно нам требуется добавить пользователя со специфическими настройками — для этого используется расширенный вариант этой команды. Перечислим основные опции:

    -m создаёт указанную домашнюю директорию, если она ещё не существует
    -d /home/test-user устанавливает /home/test-user в качестве домашней директории
    -c "Имя Фамилия" добавляет комментарий. Например, с именем пользователя
    -g test указывает группу, в которую попадёт пользователь после создания. Можно использовать с GID или именем группы. Указанная группа должна существовать. Используется в сочетании с ключом -N (отменяет автоматическое создание группы с именем пользователя)
    -G users,wheel указывает список дополнительных групп пользователя. Они перечисляются через запятую без пробелов
    -s /bin/bash позволяет настроить доступ к shell
    -r создаёт системного пользователя. Используется, когда вам нужно настроить службу на работу из-под конкретного пользователя. По умолчанию данные таких пользователей не вносятся в /etc/shadow, для них не создаётся домашняя папка
    -u позволяет указать свой UID, который будет присвоен новому пользователю. В качестве UID указывается положительное целое число. UID должен быть уникален
    -e 2021-01-01 указывает дату, до которой аккаунт будет активен. Дата задаётся в формате YYYY-MM-DD
    -f 3 указывает количество дней до блокировки пользователя, когда его пароль станет недействителен

    В итоге получится вот такая сборная солянка из настроек:

    useradd -m -u 666 -d /home/users/test-user -c "Тестовый пользователь" -e 2060-01-01 -s /bin/bash test-user

Очень важно после создания пользователя настроить для него надёжный пароль. Для этого нужно ввести следующую команду:

passwd test-user

Система предложит ввести и подтвердить пароль. На этом процесс создания пользователя можно считать завершённым.

#### Изменение данных пользователей

Смена настроек для активного пользователя может привести к сбою системы. Поэтому перед изменением данных важно убедиться, что в текущий момент редактируемый пользователь не авторизован, под ним отсутствуют запущенные процессы, редактируемые файлы. Посмотреть список запущенных процессов пользователя user можно следующим образом: 

pgrep -l -u test-user посмотреть процессы пользователя

pinky test-user Узнать авторизован ли пользователь

Отредактировать данные существующего пользователя можно с помощью команды usermod. По структуре она похожа на предыдущую команду:

usermod [что поменять] [для какого пользователя] изменение существующего пользователя

Набор параметров расширен дополнительными опциями:

    -m создаёт новую директорию, указанную в качестве домашней (если её не существует), и переносит туда данные из старой
    -d /home/users/new-test-user меняет домашнюю директорию пользователя на /home/users/new-test-user
    -c "Имя2 Фамилия2" меняет комментарий к пользователю
    -a -G users,wheel добавляет пользователя в дополнительные группы
    -s /bin/bash меняет командную оболочку пользователя
    -u 100500 изменяет UID пользователя
    -e 2060-01-01 меняет дату, до которой аккаунт будет активен
    -f 7 меняет количество дней до блокировки пользователя, когда его пароль станет недействителен
    -l new-test-user меняет имя пользователя на new-test-user
    -L блокирует аккаунт пользователя. Для этого в файле /etc/shadow перед хэшем пароля пользователя ставится символ «!»
    -U снимает блокировку с аккаунта (удаляет символ «!» из пароля в /etc/shadow)

То есть если мы захотим отредактировать данные пользователя test-user, созданного в примере выше, это будет выглядеть так:

usermod -l new-test-user -m -d /home/new-test-user -c "Имя2 Фамилия2" -u 100500 -e 3000-01-01 -f -1 test-user

#### Удаление пользователей

userdel [что удаляем] [кого удаляем]

Основных параметра два: 

    -r удаляет папки пользователя: домашнюю директорию, почтовую очередь
    -f отключает механизм защиты. При использовании этой опции пользователь будет удалён даже при наличии запущенных процессов и пр. Используется на свой страх и риск, так как может привести к сбою системы

#### Группы пользователей

Информация о группах хранится в файле /etc/group. Работа с группами пользователей куда проще. 

groupadd new-group добавить пользовательскую группу

Из параметров можно выделить следующие:

    -f если группа с указанным именем или GID уже существует, опция прерывает выполнение команды без соответствующей ошибки
    -g 100500 позволяет назначить свой GID для создаваемой группы
    -r создаёт системную группу
    -p p@ssw0rd Устанавливает для группы пароль p@ssw0rd. Пароль запрашивается системой при попытке входа в группу с помощью команды newgrp. Не рекомендуется к использованию из-за проблем с безопасностью. Настроенный таким образом пароль можно увидеть в истории команд.

###### Редактирование групп

Для редактирования групп используется команда groupmod. Список изменений задаётся с помощью параметров:
    -g 100500 меняет GID группы на 100500
    -n another-name меняет имя группы на another-name

Например, если нам нужно изменить имя группы test-group на имя named-group, команда будет выглядеть так:

groupmod -n named-group test-group переименовать группу

##### Удаление групп

Нельзя удалить группу, если она указана в качестве основной для какого-то существующего пользователя. Сначала нужно предварительно удалить этого пользователя из группы.

groupdel test-group удалить группу

###### Управление пользователями в группе

Базовым инструментом для управления группами является утилита gpasswd. Она имеет несколько параметров, но с одной особенностью — в отличие от предыдущих примеров, здесь большинство параметров (кроме -A и -M) не сочетаются. То есть в команде может быть только один параметр за раз.

gpasswd [что сделать] [в какой группе]

Рассмотрим опции команды подробнее: 

    -a new-user Добавляет пользователя new-user в группу
    -d bad-user Удаляет пользователя bad-user из группы
    -A user1,user2,... Доступна для использования привилегированным пользователям (с правами root). Назначает список пользователей-администраторов группы
    -M user1,user2,... Доступна для использования привилегированным пользователям. Назначает список участников группы
    -r Отключает пароль группы. После этого только члены группы смогут использовать команду newgrp для подключения к группе
    -R Отключает внешний доступ к группе. После этого только члены группы смогут использовать команду newgrp для подключения к группе

gpasswd -a new-user test-group добавить пользователя в группу

Также для добавления пользователей в новую группу используется описанная выше команда usermod. Следующий пример добавляет пользователя test-user в группу new-group: 

usermod -a -G new-group test-user добавить пользователя  в группу

Или, если нужно указать группу new-group в качестве основной группы пользователя test-user:

usermod -g new-group test-user добавить пользователя в группу и сделать основной

newgrp new-group добавить текущего пользователя в группу (в рамках сессии)

#### Изменение атрибутов файлов

Помимо прав доступа и владельца каждый файл может иметь ряд атрибутов, определяемых на уровне файловой системы. Атрибуты показывают, какие операции могут или не могут проводиться с файлом в принципе, независимо от того, кто им владеет.

Посмотреть атрибуты файлов в текущей директории можно с помощью команды lsattr. Если запустить её без аргументов, она выведет атрибуты всех файлов в текущей директории. Если указать путь к файлу или папке, она перечислит свойства указанного файла или списка файлов в указанной папке соответственно:

lsattr example.txt посмотреть атрибуты файла
lsattr посмотреть атрибуты файлов в папке

Первые 20 символов в строке предназначены для отображения атрибутов файла.
Список атрибутов может отличаться в зависимости от файловой системы.  
Изменить атрибуты файла позволяет команда chattr:

chattr [модификатор][изменяемые атрибуты] [целевой файл или папка]

То есть, если нам нужно защитить какой-то важный файл от посягательств, можно использовать такую команду:

chattr +i example.txt сделать файл неизменяемым

Проверяем — посягательства не работают.

Если же нам нужно вернуть файл в нормальное состояние, нужно выполнить обратную операцию: 

chattr -i example.txt

Для просмотра более подробной информации о файловых атрибутах, их ограничениях и правилах применения используйте команду:

man chattr
